#!/bin/sh
export SECRET_ROOT="$HOME/.ttypty/secrets"
export LOCAL_FS="$HOME/.fs/$(uname | tr '[:upper:]' '[:lower:]')"
[ -d "$LOCAL_FS" ] && export PATH="$LOCAL_FS/bin:$PATH"
[ -d "$HOME/.local/bin" ] && export PATH="$HOME/.local/bin:$PATH"

_motd() {
  data=$($@)
  if [ -z "$data" ]; then
    return
  fi
  echo "[$1]"
  echo "$data"
}

_caches() {
  for dir in ".cache/staticcheck" \
             ".cache/gopls" \
             ".cache/go-build" \
             ".cache/vim" \
             ".local/state/nvim/swap" \
             ".local/state/nvim/undo"; do
    dir="$HOME/$dir"
    [ -d "$dir" ] && find "$dir" -type f -mtime +1 -delete
  done
}

_caches
unset -f _caches

sshagent() {
  envfile="$HOME/.local/state/ssh-agent.env"
  mkdir -p "$(dirname "$envfile")"
  if ! pgrep -u "$USER" ssh-agent > /dev/null; then
    ssh-agent > "$envfile"
  fi
  export SSH_AUTH_SOCK="$HOME/.local/state/ssh-agent.socket"
  if [ ! -f "$SSH_AUTH_SOCK" ]; then
    . "$envfile" > /dev/null
  fi
  ssh-add "$HOME/.ssh/"*.privkey >/dev/null 2>&1
}

sshagent
unset -f sshagent
