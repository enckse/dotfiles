#!/bin/sh
export SECRET_ROOT="$HOME/.ttypty/secrets"

_motdheader() {
  echo "[$1]"
  echo "==="
}

_motd() {
  data=$($@)
  if [ -z "$data" ]; then
    return
  fi
  _motdheader "$1"
  echo "$data"
  echo
}

_caches() {
  for dir in ".cache/staticcheck" \
             ".cache/gopls" \
             ".cache/go-build" \
             ".cache/vim" \
             ".local/state/nvim/swap" \
             ".local/state/nvim/undo"; do
    dir="$HOME/$dir"
    [ -d "$dir" ] && find "$dir" -type f -mtime +1 -delete
  done
}

_caches
unset -f _caches

sshagent() {
  LOCAL_AGENT=1
  [ -e "$HOME/.config/dotfiles/ssh-agent" ] && LOCAL_AGENT=0
  if [ "$LOCAL_AGENT" -eq 1 ]; then
    envfile="$HOME/.local/state/ssh-agent.env"
    mkdir -p "$(dirname "$envfile")"
    if ! pgrep -u "$USER" '^ssh-agent$' > /dev/null; then
      ssh-agent > "$envfile"
    fi
    export SSH_AUTH_SOCK="$HOME/.local/state/ssh-agent.socket"
    if [ ! -f "$SSH_AUTH_SOCK" ]; then
      . "$envfile" > /dev/null
    fi
  fi
  ssh-add "$HOME/.ssh/"*.privkey >/dev/null 2>&1
}

sshagent
unset -f sshagent

if [ -e "$HOME/.config/dotfiles/wac" ]; then
  if command -v wac > /dev/null; then
    _motd wac motd
  else
    _motdheader wac
    echo "-> unavailable"
    echo
  fi
fi
