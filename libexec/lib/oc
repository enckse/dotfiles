#!/bin/bash

CACHE="$HOME/.local/share/opencode"
mkdir -p "$CACHE"
TARGET_DIR=$(pwd)
REAL_HOME=$HOME

bwrap \
    --ro-bind / / \
    --proc /proc \
    --dev /dev \
    --tmpfs /tmp \
    --tmpfs "$REAL_HOME" \
    --bind "$TARGET_DIR" "$TARGET_DIR" \
    --bind "$REAL_HOME/.opencode" "$REAL_HOME/.opencode" \
    --bind "$CACHE" "$CACHE" \
    --chdir "$TARGET_DIR" \
    --setenv TERM "$TERM" \
    --setenv PATH "/usr/bin:/bin:$REAL_HOME/.opencode/bin" \
    --unshare-all \
    --share-net \
    --die-with-parent \
    opencode "$@"
