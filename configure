#!/bin/bash
dotfiles() {
  SHELL_NAME="$(basename "$SHELL")"
  echo ".${SHELL_NAME}rc"
  echo ".config/ttypty/shell"
  echo ".config/ttypty/completions"
  echo ".gitconfig"
  echo ".config/ttypty/world"
  command -v kitty > /dev/null && echo ".config/kitty"
  command -v mayhem > /dev/null && echo ".config/mayhem/settings.toml"
  command -v lb > /dev/null && echo ".config/lockbox/config.toml"
  NEED_DEV=0
  case "$(uname)" in
    "Darwin")
      command -v transcodem > /dev/null && echo ".config/ttypty/transcodem.env"
      command -v reltracker > /dev/null && echo ".config/ttypty/releases.env"
      command -v statussys > /dev/null && echo ".config/ttypty/statussys"
      if [ -d "/opt/homebrew" ] || [ -d "/opt/local" ]; then
        NEED_DEV=1
        if command -v devtools > /dev/null; then
          command -v brew > /dev/null && echo ".config/ttypty/brew.devtools.sh"
          command -v port > /dev/null && echo ".config/ttypty/port.devtools.sh"
        fi
      fi
      ;;
    "Linux")
      NEED_DEV=1
      ;;
  esac
  if [ "$NEED_DEV" -eq 1 ]; then
    case "$EDITOR" in
      "vim")
        echo ".config/vim/"
        command -v devtools > /dev/null && echo ".config/ttypty/vim.devtools.sh" 
        ;;
      "hx")
        echo ".config/helix"
        ;;
    esac
    command -v efm-langserver > /dev/null && echo ".config/efm-langserver"
    command -v uv > /dev/null && echo ".config/ttypty/uv.devtools.sh"
    command -v go > /dev/null && echo ".config/ttypty/go.devtools.sh"
    echo ".ssh/"
    echo ".config/git/"
  fi
}

DIR=""
SET=""
FILE=""
[ -e "dotfiles.env" ] && source "dotfiles.env"
for SET in $(dotfiles | sort -u); do
  while IFS= read -r -d '' FILE; do
    echo "${FILE//$HOME/}"
    DIR=$(dirname "$FILE")
    [ "$DIR" != "." ] && mkdir -p "$HOME/$DIR"
    CMD="ln -sf"
    $CMD "$PWD/$FILE" "$HOME/$FILE"
  done < <(find "$SET" -type f -print0)
done

{
  echo "# generated: $(date)"
  echo "# do NOT edit"
  case "$(uname)" in
    "Darwin")
      echo "is-screen-locked"
      echo "reltracker"
      echo "StatusBarApp"
      echo "statussys"
      echo "transcodem"
      ;;
  esac
  echo "devtools"
  echo "git-uncommitted"
  command -v go > /dev/null && echo "go-lint" && echo "go-mod-updates"
} | sort > "$HOME/.config/ttypty/utils.manifest"
