#!/bin/sh -e
PROFILE="$1"
CFG="$HOME/.config/ttypty/profile"
[ -z "$PROFILE" ] && [ -e "$CFG" ] && PROFILE=$(cat "$CFG")
[ -z "$PROFILE" ] && echo "profile required" && exit 1

_deploy() {
  echo "deploying: $1"
  [ -n "$2" ] && mkdir -p "$HOME/$(dirname $1)"
  ln -sf "$PWD/$1" "$HOME/$1"
}

mkdir -p "$HOME/.local/share/completions"
_deploy ".bashrc"
_deploy ".gitconfig"
_deploy ".config/ttypty/shell" 1
_deploy ".config/lockbox/config.toml" 1
_deploy ".local/bin/git-uncommitted" 1

case "$PROFILE" in
  "dev")
    ! test -e "$HOME/.profile" && echo "file: .profile" && echo "source $HOME/.bashrc" > "$HOME/.profile"
    _deploy ".ssh/allowed_signers" 1
    for file in $(find .config/git/ -type f); do
      _deploy "$file" 1
    done
    EDITOR_CFG="$HOME/.ttypty/editor"
    mkdir -p "$HOME/.config/toolmgr"
    [ ! -e "$HOME/.config/$EDITOR" ] && [ -d "$EDITOR_CFG" ] && echo "linking: .config/editor" && ln -sf "$EDITOR_CFG" "$HOME/.config/$EDITOR"
    [ -e "$EDITOR_CFG/toolmgr.toml" ] && echo "linking: .config/editor/toolmgr" && ln -sf "$EDITOR_CFG/toolmgr.toml" "$HOME/.config/toolmgr/$EDITOR.toml"
    command -v go > /dev/null && _deploy ".local/bin/go-lint" 1 
    command -v go > /dev/null && _deploy ".local/bin/go-mod-updates" 1 
    command -v go > /dev/null && _deploy ".config/toolmgr/go.toml" 1
  ;;
  "host")
    _deploy ".local/bin/bwa" 1
    _deploy ".config/kitty/kitty.conf" 1
    _deploy ".config/waybar/config.jsonc" 1
    _deploy ".config/niri/config.kdl" 1
    _deploy ".config/toolmgr/host.toml" 1
    _deploy ".config/systemd/user/swayidle.service" 1
    for file in $(find .config/bwa/ -type f); do
      _deploy "$file" 1
    done
  ;;
esac
