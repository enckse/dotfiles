#!/bin/bash
dotfiles() {
  SHELL_NAME="$(basename "$SHELL")"
  {
    echo "#!/usr/bin/env $SHELL_NAME"
    echo "# do NOT edit, auto-generated"
    echo '[[ "$-" != *i* ]] && return'
    echo "source \"$HOME/.config/dotfiles/shell\""
  } > "$HOME/.${SHELL_NAME}rc"

  echo ".config/dotfiles/"
  echo ".ssh/"
  case "$DOTFILES_EDITOR" in
    "hx")
      echo ".config/helix/"
      ;;
    "nvim" | "vim")
      echo ".config/$DOTFILES_EDITOR/"
      ;;
    *)
      ;;
  esac
  command -v kitty > /dev/null && echo ".config/kitty"
  if [ -e "$HOME/.config/dotfiles/dev" ]; then
    echo ".local/bin/pkgversions"
    echo ".config/git/"
    if command -v go >/dev/null; then
      echo ".local/bin/go-mod-updates"
      echo ".local/bin/go-lint"
    fi
  fi
  if [ "$(uname)" = "Darwin" ]; then
    echo ".local/bin/transcode-media"
    command -v container >/dev/null && echo ".local/bin/devcontainer"
  fi
  command -v efm-langserver > /dev/null && echo ".config/efm-langserver"
  if [ ! -e "$HOME/.config/dotfiles/dev" ]; then
    {
      echo "[user]"
      echo "  useConfigOnly = true"
      echo "[include]"
      echo "  path = $PWD/.config/git/tools.config"
    } > "$HOME/.gitconfig"
  fi
}

DIR=""
SET=""
FILE=""
[ -e "dotfiles.env" ] && source "dotfiles.env"
for SET in $(dotfiles | sort -u); do
  while IFS= read -r -d '' FILE; do
    echo "${FILE//$HOME/}"
    DIR=$(dirname "$FILE")
    [ "$DIR" != "." ] && mkdir -p "$HOME/$DIR"
    CMD="ln -sf"
    $CMD "$PWD/$FILE" "$HOME/$FILE"
  done < <(find "$SET" -type f -print0)
done
