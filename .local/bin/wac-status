#!/bin/sh
SUPPRESS="$HOME/.cache/wac.suppress"
if [ -e "$SUPPRESS" ]; then
  find "$SUPPRESS" -type f -mtime +1 -delete
fi

_cmd() {
  [ -e "$SUPPRESS" ] && date +%Y-%m-%d && return
  curl --silent 'http://server.ttypty.com/status.txt'

}

JSON=0
if [ -n "$1" ]; then
  case "$1" in
    "json")
      JSON=1
      ;;
    "suppress")
      STATUS="clearing"
      if [ -e "$SUPPRESS" ]; then
        rm -f "$SUPPRESS"
      else
        STATUS="setting"
        touch "$SUPPRESS"
      fi
      echo "$STATUS"
      exit 0
      ;;
  esac
fi

FOUND=1
WARN=""
DATA=$(_cmd)
for DAYS in 0 1; do
  OFFSET=$((DAYS*86400))
  DATE=$(date -d @$(( $(date +"%s") - OFFSET)) +"%Y-%m-%d")
  if echo "$DATA" | grep -q "$DATE"; then
    [ "$JSON" -eq 0 ] && exit 0
    [ "$DAYS" -ne 0 ] && WARN="warning"
    FOUND=1
    break
  fi
done
[ "$JSON" -eq 0 ] && echo "problems detected" && exit 1
ICON=""
[ "$FOUND" -eq 1 ] && ICON=""
printf "{\"text\": \"%s wac\", \"class\": \"%s\"}" "$ICON" "$WARN"
