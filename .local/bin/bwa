#!/bin/bash
EXE=bwa
CONFIGS="$HOME/.config/$EXE/"
ALPINE="$HOME/.alpine"
CACHE_DIR="$HOME/.cache/apks"
mkdir -p "$ALPINE" "$CACHE_DIR"

! command -v apk > /dev/null && echo "no apk?" && exit 1

[ -z "$1" ] && echo "name required" && exit 1

IS_UPDATE="--update"
if [ "$1" = "completions" ]; then
  cat << EOF
# $EXE completion

_$EXE() {
  local cur opts
  cur=\${COMP_WORDS[COMP_CWORD]}
  if [ "\$COMP_CWORD" -eq 1 ]; then
    opts="\$(ls $CONFIGS | tr '\n' ' ')"
    COMPREPLY=( \$(compgen -W "\$opts" -- "\$cur") )
  else
    if [ "\$COMP_CWORD" -eq 2 ]; then
      opts="$IS_UPDATE"
      COMPREPLY=( \$(compgen -W "\$opts" -- "\$cur") )
    fi 
  fi
}

complete -F _$EXE -o bashdefault $EXE 
EOF
  exit 0
fi

CMD="$2"

TARGET_DIR=$(pwd)
REAL_HOME="$HOME"
ALPINE="$ALPINE/$1"
REPOSITORIES="https://dl-cdn.alpinelinux.org/alpine/edge/main https://dl-cdn.alpinelinux.org/alpine/edge/community"
BWRAP_OPTS=""

[ ! -e "$CONFIGS/$1" ] && echo "no config for $1" && exit 1
source "$CONFIGS/$1"
DIR_BINDS="Downloads Workspace $DIR_BINDS"
APKS="alpine-base ripgrep docs curl bash bash-completion $APKS"

"$0" "completions" > "$SHELL_COMPS/bwa.sh"

_apks() {
  REPOS=$(echo "$REPOSITORIES" | tr ' ' '\n' | sed 's/^/-X /g')
  apk \
    $REPOS \
    -p "$ALPINE" --cache-dir "$CACHE_DIR" \
    $@
}

CREATED=0
if [ ! -d "$ALPINE" ]; then
  _apks --usermode --allow-untrusted --initdb add $APKS
  grep "^$USER:" /etc/passwd >> "$ALPINE/etc/passwd"
  grep "^$USER:" /etc/group >> "$ALPINE/etc/group"
  echo "$REPOSITORIES" | tr ' ' '\n' >> "$ALPINE/etc/apk/repositories"
  mkdir -p "$ALPINE/etc/apk/cache"
  CREATED=1
fi

if [ "$CREATED" -eq 0 ] && [ "$CMD" = "$IS_UPDATE" ]; then
  _apks update
  _apks upgrade
  _apks add "$APKS"
fi

BINDS=""
CHDIR="$REAL_HOME"
for DIR in $(echo "$DIR_BINDS" | tr ' ' '\n'); do
  BINDS="$BINDS --bind $REAL_HOME/$DIR $REAL_HOME/$DIR"
  if echo "$PWD" | grep -q "/$DIR"; then
    CHDIR="$TARGET_DIR"
  fi
done

echo "$1" > "$ALPINE/etc/hostname"
cp /etc/resolv.conf "$ALPINE/etc/"
exec bwrap \
    --bind "$ALPINE" / \
    --proc /proc \
    --dev /dev \
    $BWRAP_OPTS \
    --tmpfs /tmp \
    --setenv CONTAINER_NAME "$1" \
    $BINDS \
    --chdir $CHDIR \
    --setenv TERM "$TERM" \
    --unshare-all \
    --share-net \
    --die-with-parent \
    /bin/bash --login
