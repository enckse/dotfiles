#!/bin/sh -e
KITTY_VERSION="0.45.0"
KITTY_URL="https://github.com/kovidgoyal/kitty/releases/download/v$KITTY_VERSION/kitty-$KITTY_VERSION-x86_64.txz"
AGE_VERSION="1.3.1"
AGE_URL="https://github.com/FiloSottile/age/releases/download/v$AGE_VERSION/age-v$AGE_VERSION-linux-amd64.tar.gz"
APK_VERSION="3.0.4"
APK_URL="https://gitlab.alpinelinux.org/api/v4/projects/5/packages/generic/v$APK_VERSION/x86_64/apk.static"

WORKDIR=$(mktemp -d -t "hosttools_XXXXXX")

cleanup() {
  rm -rf "$WORKDIR"
}

trap cleanup EXIT INT TERM

_update() {
  if command -v $1 >/dev/null; then
    if $1 --version | grep -q "$2"; then
      return
    fi  
  fi
  echo "updating: $1"
  TAR="$(basename "$3")"
  curl  -L "$3" > "$WORKDIR/$TAR"
  DIR="$WORKDIR/$1"
  mkdir -p "$DIR"
  if file "$WORKDIR/$TAR" | grep -q "compressed data"; then
    (cd "$DIR" && tar xf "../$TAR")
  else
    install -Dm755 "$WORKDIR/$TAR" "$DIR/"
  fi 
  LIBEXEC="$HOME/.local/libexec/$1/"
  mkdir -p "$LIBEXEC"
  rsync -avc --delete-after "$DIR/" "$LIBEXEC"
}

_update kitty " $KITTY_VERSION " "$KITTY_URL" 
_update age "^v$AGE_VERSION\$" "$AGE_URL"
_update apk " $APK_VERSION," "$APK_URL"
