#!/bin/sh
CLIP="pbcopy"
PASTE="pbpaste"
TERMINAL_NAME="/kitty"
APP="/Applications/ClipMgr.app"

if [ -z "$1" ]; then
  if ! pgrep -f "$APP" > /dev/null; then
    open "$APP"
  fi
  exit 0
fi

CACHE="$HOME/.cache/clipmgr"
mkdir -p "$CACHE"
find "$CACHE" -type f -mtime +3 -delete
LOG="$CACHE/$(date +%Y-%m-%d).log"

{
  date
  echo "initialized"
  COUNT=0
  while [ "$COUNT" -lt 10 ]; do
    sleep 1
    if ! pgrep -f -q "$TERMINAL_NAME"; then
      COUNT=$((COUNT+1))
    fi
    if [ -z "$($PASTE)" ]; then
      continue
    fi
    CURRENT=$($PASTE | sha256sum | cut -c 1-7)
    CLEAR=120
    while [ "$CLEAR" -gt 0 ]; do
      READ=$($PASTE | sha256sum | cut -c 1-7)
      [ "$READ" != "$CURRENT" ] && break
      CLEAR=$((CLEAR-1))
      sleep 1
    done
    if [ "$CLEAR" -eq 0 ]; then
      date
      echo "clearing clipboard"
      printf "" | $CLIP
    fi
    COUNT=0
  done
  echo "exiting"
  date
} >> "$LOG" 2>&1
