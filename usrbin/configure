#!/bin/sh -e
OS=$(uname | tr '[:upper:]' '[:lower:]')
[ -z "$PKGS_STORE" ] && echo "PKGS_STORE must be set" && exit 1 
export PATH="../.local/libexec:$PATH"
PKGS="$PKGS_STORE/pkgs"
genusrbin \
  -s "$PWD/enabled" \
  -w "$PKGS_STORE/archives" \
  -b "$PKGS" \
  -a aarch64 \
  -p "$OS"

{
  for FILE in "$PKGS/"*; do
    SOURCE="$(find "$FILE" -name ".usrbin" -type f -exec stat -f "%m %N" {} + | sort -n | head -n 1 | cut -d " " -f 2-)"
    [ -z "$SOURCE" ] && continue
    echo "source \"$SOURCE\""  
  done
} > "$PKGS_STORE/env"

echo "success"
